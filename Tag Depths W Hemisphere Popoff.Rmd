---
title: "Mobula Ray Tag Depths"
author: "Jennifer Stahl"
date: "2024-10-01"
output:
  html_document: default
  pdf_document: default
---

#Purpose - Create visualizations for Mobula ray depth data for tags that popoff in the eastern hemisphere.

##To update code for a new tag, use find and replace all for 1) the tag Ptt number (for example replace 234820 with 234820) and 2) time zone (for example replace Etc/GMT+10 with Etc/GMT+11) in 1) for time conversion from UTC to popoff time zone (line 67), 2) line plot function, and 3) boxplot function. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
##Load libraries
```{r}
library(tidyverse)
library(lubridate)
library(ggplot2)
library(suncalc)#use in bret's line and boxplots
library(suntools)#alternative package to get sunrise, sunset, dusk, dawn
library(lutz)#use to determine time zone based on lat/long
```

##Read in data.
```{r}
Depths_234820 <-read.csv(file="C:/R_git_stuff/Mobula-tag-depths/234820-Series.csv", header=TRUE, sep=",")

#head(Depths_234820)
#glimpse(Depths_234820)
#dim(Depths_234820) 
```

#Format time and convert to tag popoff time zone.
##Goal - Create a date/time field based on tag popoff location so vertical data can be displayed with local date/time with correct day/night shading for visualization.

###Combine date and time fields to get datetime field in UTC.
```{r}
Depths_234820$datetime = dmy_hms(paste(Depths_234820$Day,Depths_234820$Time))
```

##Determine local time zone based on popoff location. 
###1) Read in csv with popoff lat/longs for all tags.
###2) Create a new data frame with popoff lat/long for tag of interest.
###3) Look up time zone based on popoff lat/long for tag of interest and add to data frame with popoff lat/long.
###4) Join the depth data frame and popoff location and time zone data frame.
```{r}
Popoff_loc <-read.csv(file="C:/R_git_stuff/Mobula-tag-depths/Mobula_locations.csv", header=TRUE, sep=",")

Popoff_loc_234820 <- Popoff_loc %>% 
  filter(Ptt == 234820) %>%
  select(Popoff_lat, Popoff_long) %>%
  mutate(Ptt = as.integer(234820))

Popoff_loc_234820$Popoff_tz <- tz_lookup_coords(Popoff_loc_234820$Popoff_lat, Popoff_loc_234820$Popoff_long, method = "accurate")

Depths_234820 <- left_join(Depths_234820,Popoff_loc_234820, by = join_by (Ptt))
```

##Create new column with date/time info for tag popoff location time zone. 
***UPDATE LINE 68 with correct tag time zone.
###Note UTC and GMT is the same. 
```{r}
Depths_234820$Popoff_datetime = Depths_234820$datetime %>%
  lubridate:::ymd_hms(tz="UTC") %>% 
    with_tz(tzone="Etc/GMT+10")

#Issues: If you get an error that anything recorded at midnight (00:00:00) failed to parse and will get NAs. Run below code to add date/times for NAs based on prior or subsequent recorded date/times. 
```
###Run below code to interpolate date/times for NAs created from formatting issues at midnight (due to Wildlife Computer formating of 00:00:00) to interpolate date/time based on previous or subsequent observations with observations recorded every 10 minutes or these tags. 
```{r}
mins_in_interval <- 10 #This is based on 10 minute intervals and needs to be updated if interval is different.
z <- Depths_234820$Popoff_datetime #Create a new variable z with datetime info to update.
na_rows <- which(is.na(z))#creates variable na_rows to identify rows that were updated from NA in below code.
z[which(is.na(z))] <- z[which(is.na(z)) + 1] - mins_in_interval*60 #interpolates NA row with date/time from previous 10 minute interval.
z[which(is.na(z))] <- z[which(is.na(z)) - 1] + mins_in_interval*60 #interpolates NA row with date/time from following 10 minute interval.
Depths_234820$Popoff_datetime <- z #update Popoff_datetime field with z variable.
```
#####can check which NA rows were updated and the offset (conversion) from UTC.
#####Note Etc/GMT+10 has an offset of UTC-10. I don't understand naming at all.

```{r}
Depths_234820$Popoff_datetime[na_rows]
```
*****************************************************************************************************
#Line Plots

##Goals: 1)Create line plots for daily depth data to visualize depth data for end of tag deployment. 2)Filter out any bad data, such as when tag is floating and rerun line plot code.

###The line plot code is based off of code Bret cooper developed. Follow below steps to run the code:
####1)Add .R file with code to working directory (depth_plot_good_label_updated.R). 
####2)Load .R into Rstudio and hit source button on top right or run source("depth_plot_good_label_updated.R")
####3)Create a date/time field with local time based on popoff lat/long. Run interpolation code if any NAs are created at midnight due to formatting (00:00:00). (This should have been done already with time conversion pre-processing.)
####4)Run the function in the .R file (brett_depth_plot_good_label() and change inputs. Note if run code in console then will go to plots and can export there otherwise will need to run with ggsave to export.

```{r}
source("Tag depth line plots.R")
```

##update the code with the correct poppoff time zone (from tz_lookup_coords) and the offset from HST time zone which is UTC - 10, for display.

```{r}
brett_depth_plot_good_label_yaxis(Depths_234820, "Etc/GMT+10", "Tag ID 234820", x_label = "Date/time (HST))", ylims = c(400, 0))

ggsave("234820_lineplot.png")
```

**************************************************************************
#BOXPLOTS
##Line in boxplot is median depth. Boxes represent the 25% and 75% percentile depth. Vertical lines are max and min depths. Dots are the "outliers", which are probably just infrequent dives. Alternatively could use a violin plot instead.

##Bret Cooper code
```{r}
source("Tag depth boxplot.R")
```

##Update code with the correct poppoff time zone (from tz_lookup_coords) and time offset from HST time zone which is UTC - 10, for display.
```{r}
#run below code if need to filter out bad data.
brett_box_plot(Depths_234820, "Etc/GMT+10", "Tag ID 234820", x_label = "Hours (HST)", ylims = c(400, 0))

ggsave("234820_boxplot.png")
```
